name: AI Compliance Check

on:
  push:
    branches: [main, development]
  pull_request:
    branches: [main, development]

jobs:
  compliance-check:
    name: Compliance Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff analysis
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Get changed files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PRs, compare against base branch
            BASE_SHA=${{ github.event.pull_request.base.sha }}
            HEAD_SHA=${{ github.event.pull_request.head.sha }}
            CHANGED=$(git diff --name-only --diff-filter=ACM $BASE_SHA..$HEAD_SHA | grep -E '\.(ts|tsx|js|jsx)$' || true)
          else
            # For pushes, compare against previous commit
            CHANGED=$(git diff --name-only --diff-filter=ACM HEAD~1..HEAD | grep -E '\.(ts|tsx|js|jsx)$' || true)
          fi
          
          if [ -z "$CHANGED" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No TypeScript/JavaScript files changed"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "$CHANGED" > changed_files.txt
            echo "Changed files:"
            echo "$CHANGED"
          fi
      
      - name: Run Pre-Execution Compliance Check
        id: pre-check
        if: steps.changed-files.outputs.changed == 'true'
        run: |
          echo "ðŸ›¡ï¸ Running pre-execution compliance checks..."
          
          CHANGED_FILES=$(cat changed_files.txt | tr '\n' ' ')
          
          # Run pre-execution check
          if [ -f "tools/compliance/pre-execution-check.js" ]; then
            PRE_RESULT=$(node tools/compliance/pre-execution-check.js "CI compliance check" $CHANGED_FILES 2>&1)
            PRE_EXIT=$?
            
            echo "===PRE-EXECUTION CHECK OUTPUT==="
            echo "$PRE_RESULT"
            echo "===END PRE-CHECK OUTPUT==="
            
            if [ $PRE_EXIT -ne 0 ]; then
              echo "âŒ Pre-execution check failed with exit code $PRE_EXIT"
              exit 1
            fi
            
            # Extract status from JSON output
            PRE_STATUS=$(echo "$PRE_RESULT" | grep -o '"status":"[^"]*"' | cut -d'"' -f4 || echo "UNKNOWN")
            
            if [ "$PRE_STATUS" = "BLOCK" ]; then
              echo "âŒ Pre-execution check BLOCKED - violations detected"
              echo "$PRE_RESULT"
              exit 1
            elif [ "$PRE_STATUS" = "WARN" ]; then
              echo "âš ï¸ Pre-execution check WARNED - proceeding with caution"
              echo "$PRE_RESULT"
            else
              echo "âœ… Pre-execution check PASSED"
            fi
          else
            echo "âš ï¸ Pre-execution check script not found, skipping"
          fi
      
      - name: Run Post-Execution Compliance Check
        id: post-check
        if: steps.changed-files.outputs.changed == 'true'
        run: |
          echo "ðŸ›¡ï¸ Running post-execution compliance checks..."
          
          CHANGED_FILES=$(cat changed_files.txt | tr '\n' ' ')
          
          # Run post-execution check
          if [ -f "tools/compliance/post-execution-check.js" ]; then
            POST_RESULT=$(node tools/compliance/post-execution-check.js $CHANGED_FILES 2>&1)
            POST_EXIT=$?
            
            echo "===POST-EXECUTION CHECK OUTPUT==="
            echo "$POST_RESULT"
            echo "===END POST-CHECK OUTPUT==="
            
            if [ $POST_EXIT -ne 0 ]; then
              echo "âš ï¸ Post-execution check found violations (exit code $POST_EXIT)"
              echo "$POST_RESULT"
              # Don't fail the build for post-check violations, but report them
            else
              echo "âœ… Post-execution check PASSED"
            fi
          else
            echo "âš ï¸ Post-execution check script not found, skipping"
          fi
      
      - name: Check for bypass flags in commit messages
        run: |
          echo "ðŸ” Checking commit messages for bypass attempts..."
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            COMMITS=$(git log --format="%B" ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          else
            COMMITS=$(git log --format="%B" -1)
          fi
          
          # Check for bypass flags in commit messages
          if echo "$COMMITS" | grep -qiE "\[skip.*ci\]|\[no.*verify\]|\[bypass\]|--no-verify|--no-gpg-sign"; then
            echo "âŒ ERROR: Bypass flags detected in commit message!"
            echo "Commit messages cannot contain: [skip ci], [no verify], [bypass], --no-verify, --no-gpg-sign"
            echo ""
            echo "Commits:"
            echo "$COMMITS"
            exit 1
          fi
          
          echo "âœ… No bypass flags detected in commit messages"
      
      - name: Compliance check summary
        if: always()
        run: |
          echo "## ðŸ›¡ï¸ Compliance Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.pre-check.outcome }}" == "success" ]; then
            echo "âœ… Pre-execution check: **PASSED**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.pre-check.outcome }}" == "failure" ]; then
            echo "âŒ Pre-execution check: **BLOCKED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ Pre-execution check: **SKIPPED**" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.post-check.outcome }}" == "success" ]; then
            echo "âœ… Post-execution check: **PASSED**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.post-check.outcome }}" == "failure" ]; then
            echo "âš ï¸ Post-execution check: **VIOLATIONS DETECTED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ Post-execution check: **SKIPPED**" >> $GITHUB_STEP_SUMMARY
          fi

